name: ğŸ­ PPuRI-AI Ultimate CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '18'
  POETRY_VERSION: '1.7.1'

jobs:
  # =============================================================================
  # ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  # =============================================================================
  code-quality:
    name: ğŸ” Code Quality & Security
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Poetry ì„¤ì¹˜
      uses: snok/install-poetry@v1
      with:
        version: ${{ env.POETRY_VERSION }}
        
    - name: ğŸ”§ Poetry ì„¤ì •
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true
        
    - name: ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        poetry install
        
    - name: ğŸ¨ ì½”ë“œ í¬ë§· ê²€ì‚¬ (Black)
      run: |
        poetry run black --check --diff --line-length 120 .
        
    - name: ğŸ” ë¦°íŠ¸ ê²€ì‚¬ (Ruff)
      run: |
        poetry run ruff check .
        
    - name: ğŸ”’ ë³´ì•ˆ ê²€ì‚¬ (Bandit)
      run: |
        poetry run bandit -r . -f json -o bandit-report.json
        
    - name: ğŸ“Š íƒ€ì… ê²€ì‚¬ (mypy)
      run: |
        poetry run mypy --ignore-missing-imports --python-version 3.9 .
        
    - name: ğŸ” ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ (Safety)
      run: |
        poetry run safety check
        
    - name: ğŸ“„ ë³´ì•ˆ ë³´ê³ ì„œ ì—…ë¡œë“œ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.json
          
  # =============================================================================
  # ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  # =============================================================================
  test:
    name: ğŸ§ª Test Suite
    runs-on: ubuntu-latest
    needs: code-quality
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: ppuri_test
          POSTGRES_USER: ppuri
          POSTGRES_PASSWORD: ppuri_test_2024
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
          
      neo4j:
        image: neo4j:5.15-community
        env:
          NEO4J_AUTH: neo4j/ppuri_test_2024
        options: >-
          --health-cmd "cypher-shell -u neo4j -p ppuri_test_2024 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 7474:7474
          - 7687:7687
          
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Poetry ì„¤ì¹˜
      uses: snok/install-poetry@v1
      with:
        version: ${{ env.POETRY_VERSION }}
        
    - name: ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        poetry install
        
    - name: ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      env:
        DATABASE_URL: postgresql+asyncpg://ppuri:ppuri_test_2024@localhost:5432/ppuri_test
        REDIS_URL: redis://localhost:6379/0
        NEO4J_URI: bolt://localhost:7687
        NEO4J_USER: neo4j
        NEO4J_PASSWORD: ppuri_test_2024
        ENVIRONMENT: test
      run: |
        poetry run pytest tests/unit/ -v --cov=. --cov-report=xml --cov-report=html
        
    - name: ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      env:
        DATABASE_URL: postgresql+asyncpg://ppuri:ppuri_test_2024@localhost:5432/ppuri_test
        REDIS_URL: redis://localhost:6379/0
        NEO4J_URI: bolt://localhost:7687
        NEO4J_USER: neo4j
        NEO4J_PASSWORD: ppuri_test_2024
        ENVIRONMENT: test
      run: |
        poetry run pytest tests/integration/ -v --cov-append --cov-report=xml --cov-report=html
        
    - name: ğŸ“Š ì»¤ë²„ë¦¬ì§€ ë³´ê³ ì„œ ì—…ë¡œë“œ
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        
    - name: ğŸ“„ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          coverage.xml
          htmlcov/
          
  # =============================================================================
  # ğŸ³ Docker ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  # =============================================================================
  docker:
    name: ğŸ³ Docker Build & Test
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ³ Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” Docker Hub ë¡œê·¸ì¸
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ (ê°œë°œ)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile
        target: development
        push: false
        tags: ppuri-ai-ultimate:dev
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ (í”„ë¡œë•ì…˜)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile
        target: production
        push: ${{ github.event_name != 'pull_request' }}
        tags: |
          ppuri-ai-ultimate:latest
          ppuri-ai-ultimate:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ğŸ§ª Docker ì»¨í…Œì´ë„ˆ í…ŒìŠ¤íŠ¸
      run: |
        docker run --rm ppuri-ai-ultimate:dev python -c "import sys; print(sys.version)"
        
    - name: ğŸ” Docker ì´ë¯¸ì§€ ë³´ì•ˆ ìŠ¤ìº”
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ppuri-ai-ultimate:dev'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ğŸ“Š ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
        
  # =============================================================================
  # ğŸš€ ë°°í¬ (main ë¸Œëœì¹˜ë§Œ)
  # =============================================================================
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [code-quality, test, docker]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: production
      url: https://ppuri-ai.com
      
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ” AWS ìê²©ì¦ëª… ì„¤ì •
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-2
        
    - name: ğŸš€ EC2 ë°°í¬
      run: |
        echo "í”„ë¡œë•ì…˜ ë°°í¬ ì‹œì‘..."
        # ì‹¤ì œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì—¬ê¸°ì— êµ¬í˜„
        
    - name: ğŸ”” ë°°í¬ ì•Œë¦¼ (Slack)
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#ppuri-ai-alerts'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        
  # =============================================================================
  # ğŸ“‹ Release Notes ìƒì„±
  # =============================================================================
  release:
    name: ğŸ“‹ Create Release
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ·ï¸ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
      uses: release-drafter/release-drafter@v5
      with:
        config-name: release-drafter.yml
        disable-autolabeler: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
  # =============================================================================
  # ğŸ” ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
  # =============================================================================
  performance:
    name: ğŸ” Performance Monitoring
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Poetry ì„¤ì¹˜
      uses: snok/install-poetry@v1
      with:
        version: ${{ env.POETRY_VERSION }}
        
    - name: ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        poetry install
        
    - name: ğŸš€ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰
      run: |
        poetry run pytest tests/performance/ -v --benchmark-only --benchmark-json=benchmark.json
        
    - name: ğŸ“Š ì„±ëŠ¥ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: performance-results
        path: benchmark.json
        
    - name: ğŸ’¬ PR ì„±ëŠ¥ ì½”ë©˜íŠ¸
      uses: benchmark-action/github-action-benchmark@v1
      with:
        tool: 'pytest'
        output-file-path: benchmark.json
        comment-on-pr: true
        github-token: ${{ secrets.GITHUB_TOKEN }}
        
  # =============================================================================
  # ğŸ“ ë¬¸ì„œ ì—…ë°ì´íŠ¸
  # =============================================================================
  docs:
    name: ğŸ“ Update Documentation
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“š ë¬¸ì„œ ìƒì„± ë„êµ¬ ì„¤ì¹˜
      run: |
        pip install sphinx sphinx-rtd-theme
        
    - name: ğŸ“– API ë¬¸ì„œ ìƒì„±
      run: |
        sphinx-build -b html docs/ docs/_build/html
        
    - name: ğŸ“¤ ë¬¸ì„œ ë°°í¬
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/_build/html
        
  # =============================================================================
  # ğŸ ì‘ì—… ì™„ë£Œ ì•Œë¦¼
  # =============================================================================
  notify:
    name: ğŸ Workflow Complete
    runs-on: ubuntu-latest
    needs: [code-quality, test, docker]
    if: always()
    
    steps:
    - name: ğŸ“Š ì‘ì—… ìƒíƒœ í™•ì¸
      run: |
        echo "Code Quality: ${{ needs.code-quality.result }}"
        echo "Tests: ${{ needs.test.result }}"
        echo "Docker: ${{ needs.docker.result }}"
        
    - name: ğŸ”” Discord ì•Œë¦¼
      if: always()
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK }}
        title: "PPuRI-AI Ultimate CI/CD"
        description: "ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
        color: ${{ job.status == 'success' && '0x00ff00' || '0xff0000' }}
        
    - name: ğŸ“§ ì´ë©”ì¼ ì•Œë¦¼ (ì‹¤íŒ¨ ì‹œ)
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ğŸš¨ PPuRI-AI Ultimate CI/CD ì‹¤íŒ¨"
        body: "ë¹Œë“œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."
        to: ${{ secrets.ADMIN_EMAIL }}
        from: "PPuRI-AI Ultimate CI/CD"