# PPuRI-AI Ultimate Dockerfile
# KITECH ê²€ì¦ëœ ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œ íŒ¨í„´ ê¸°ë°˜

# ğŸ—ï¸ Build Stage - ì˜ì¡´ì„± ë° ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¹Œë“œ
FROM python:3.11-slim as builder

# ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Python ì˜ì¡´ì„± ë¹Œë“œ
WORKDIR /build
COPY requirements.txt .
RUN pip install --no-cache-dir --user -r requirements.txt

# ğŸš€ Production Stage - ìµœì í™”ëœ ëŸ°íƒ€ì„
FROM python:3.11-slim as production

# ëŸ°íƒ€ì„ ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    curl \
    tesseract-ocr \
    tesseract-ocr-kor \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# ë¹„root ì‚¬ìš©ì ìƒì„± (ë³´ì•ˆ ê°•í™”)
RUN groupadd -r ppuri && useradd -r -g ppuri ppuri

# ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# Python íŒ¨í‚¤ì§€ ë³µì‚¬ (builder stageì—ì„œ)
COPY --from=builder /root/.local /home/ppuri/.local
ENV PATH=/home/ppuri/.local/bin:$PATH

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . .

# ê¶Œí•œ ì„¤ì •
RUN chown -R ppuri:ppuri /app
RUN mkdir -p /app/data /app/logs /app/config && \
    chown -R ppuri:ppuri /app/data /app/logs /app/config

# KITECH ê²€ì¦ëœ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (5ì´ˆ ë¹ ë¥¸ ì‹œì‘)
ENV PRELOAD_EMBEDDING_MODEL=false
ENV ENABLE_EXTERNAL_ACCESS=true
ENV CORS_ORIGINS=*
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8000

# ì‚¬ìš©ì ì „í™˜
USER ppuri

# í—¬ìŠ¤ì²´í¬ (KITECH íŒ¨í„´)
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
CMD ["python", "-m", "uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "1"]

# ğŸ§ª Development Stage - ê°œë°œìš© í™•ì¥ ê¸°ëŠ¥
FROM production as development

# ê°œë°œ ë„êµ¬ ì„¤ì¹˜
USER root
RUN pip install --no-cache-dir \
    pytest \
    pytest-asyncio \
    pytest-cov \
    black \
    ruff \
    mypy \
    jupyter \
    ipython

# ê°œë°œìš© í™˜ê²½ ë³€ìˆ˜
ENV DEBUG=true
ENV RELOAD=true
ENV LOG_LEVEL=DEBUG

# ê°œë°œìš© ë³¼ë¥¨ ë§ˆìš´íŠ¸ í¬ì¸íŠ¸
VOLUME ["/app/data", "/app/logs", "/app/config"]

USER ppuri

# ê°œë°œ ì„œë²„ ì‹œì‘ (í•« ë¦¬ë¡œë“œ)
CMD ["python", "-m", "uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload", "--log-level", "debug"]

# ğŸ§ª Testing Stage - í…ŒìŠ¤íŠ¸ ì „ìš©
FROM development as testing

USER root

# í…ŒìŠ¤íŠ¸ ì˜ì¡´ì„± ì¶”ê°€ ì„¤ì¹˜
RUN pip install --no-cache-dir \
    pytest-xdist \
    pytest-mock \
    factory-boy \
    faker

USER ppuri

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
CMD ["python", "-m", "pytest", "tests/", "-v", "--cov=.", "--cov-report=html", "--cov-report=term"]

# ğŸ“Š Monitoring Stage - ëª¨ë‹ˆí„°ë§ ê¸°ëŠ¥ ê°•í™”
FROM production as monitoring

USER root

# ëª¨ë‹ˆí„°ë§ ë„êµ¬ ì„¤ì¹˜
RUN pip install --no-cache-dir \
    prometheus-client \
    opentelemetry-api \
    opentelemetry-sdk \
    opentelemetry-instrumentation-fastapi \
    opentelemetry-exporter-prometheus

USER ppuri

# ëª¨ë‹ˆí„°ë§ ì„¤ì •
ENV PROMETHEUS_ENABLED=true
ENV METRICS_PORT=9090
ENV OPENTELEMETRY_ENABLED=true

# ëª¨ë‹ˆí„°ë§ í¬íŠ¸ ì¶”ê°€ ë…¸ì¶œ
EXPOSE 9090

# Labels for better container management
LABEL maintainer="PPuRI-AI Team" \
      version="1.0.0" \
      description="PPuRI-AI Ultimate - ë¿Œë¦¬ì‚°ì—… ì „ìš© AI ì‹œìŠ¤í…œ" \
      architecture="multi-stage" \
      base-pattern="KITECH-verified" \
      optimization="5-second-startup"

# ğŸ¯ ìµœì í™” ì„¤ì •
# - ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œë¡œ ì´ë¯¸ì§€ í¬ê¸° ìµœì†Œí™”
# - KITECH ê²€ì¦ëœ 5ì´ˆ ì‹œì‘ ìµœì í™”
# - ë¹„root ì‚¬ìš©ìë¡œ ë³´ì•ˆ ê°•í™”
# - í—¬ìŠ¤ì²´í¬ë¡œ ì•ˆì •ì„± í™•ë³´
# - ê°œë°œ/í…ŒìŠ¤íŠ¸/ëª¨ë‹ˆí„°ë§ ìŠ¤í…Œì´ì§€ ë¶„ë¦¬